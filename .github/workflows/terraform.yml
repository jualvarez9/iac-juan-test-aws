name: 'Terraform IAC AWS Workflow'

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  terraform:
    name: 'Terraform'
    runs-on: [self-hosted, k3s, aws]
    environment: production

    defaults:
      run:
        shell: bash

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      TERRAFORM_VERSION: "1.6.6"
        
    steps:
    - name: Setup working directory
      run: |
        echo "=== Configurando directorio de trabajo ==="
        pwd
        ls -la
        mkdir -p ${{ github.workspace }} || true
        cd ${{ github.workspace }}
        echo "Directorio actual: $(pwd)"
        echo "Contenido: $(ls -la)"

    - name: Checkout
      uses: actions/checkout@v4

    - name: Check available space
      run: |
        echo "=== Directorio actual ==="
        pwd
        echo "=== Espacio disponible inicial ==="
        df -h
        echo "=== Limpiando espacio ==="
        sudo apt-get clean || true
        sudo rm -rf /tmp/terraform* /tmp/.terraform* 2>/dev/null || true
        sudo journalctl --vacuum-time=1d 2>/dev/null || true
        echo "=== Espacio después de limpieza ==="
        df -h

    - name: Install Terraform
      run: |
        echo "=== Directorio actual: $(pwd) ==="
        
        # Verificar si terraform ya está instalado
        if command -v terraform &> /dev/null; then
          echo "Terraform ya está instalado: $(terraform version)"
          exit 0
        fi
        
        echo "Instalando Terraform ${TERRAFORM_VERSION}..."
        
        # Crear directorio temporal si no existe
        mkdir -p /tmp
        cd /tmp
        
        # Descargar e instalar Terraform
        wget -q https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
        unzip -q terraform_${TERRAFORM_VERSION}_linux_amd64.zip
        sudo mv terraform /usr/local/bin/
        sudo chmod +x /usr/local/bin/terraform
        
        # Limpiar archivos de descarga
        rm -f terraform_${TERRAFORM_VERSION}_linux_amd64.zip
        
        # Volver al directorio de trabajo
        cd ${{ github.workspace }}
        
        # Verificar instalación
        terraform version
        echo "Terraform instalado correctamente"

    - name: Terraform Init
      working-directory: ${{ github.workspace }}
      run: |
        echo "=== Directorio actual: $(pwd) ==="
        echo "=== Verificando espacio antes de init ==="
        df -h
        
        echo "=== Limpiando cache previo de Terraform ==="
        rm -rf .terraform* terraform.tfstate* 2>/dev/null || true
        
        echo "=== Inicializando Terraform ==="
        terraform init -no-color

    - name: Extract tfvars desde el commit
      id: extract_tfvars
      working-directory: ${{ github.workspace }}
      run: |
        TFVARS_FILE=$(echo "${COMMIT_MESSAGE}" | grep -o '\S*\.tfvars' || echo "")
        if [ -z "$TFVARS_FILE" ]; then
          echo "No se encontró archivo .tfvars en el mensaje del commit"
          echo "TFVARS_FILE=" >> $GITHUB_OUTPUT
        else
          echo "Archivo tfvars encontrado: $TFVARS_FILE"
          echo "TFVARS_FILE=$TFVARS_FILE" >> $GITHUB_OUTPUT
        fi

    - name: Terraform Format
      working-directory: ${{ github.workspace }}
      run: terraform fmt

    - name: Terraform Plan
      working-directory: ${{ github.workspace }}
      run: |
        if [ -n "${{ steps.extract_tfvars.outputs.TFVARS_FILE }}" ]; then
          terraform plan -input=false -var-file=${{ steps.extract_tfvars.outputs.TFVARS_FILE }}
        else
          terraform plan -input=false
        fi

    - name: Terraform Apply
      if: contains(github.event.head_commit.message, 'deploy') && !contains(github.event.head_commit.message, 'destroy')
      working-directory: ${{ github.workspace }}
      run: |
        if [ -n "${{ steps.extract_tfvars.outputs.TFVARS_FILE }}" ]; then
          terraform apply -auto-approve -var-file=${{ steps.extract_tfvars.outputs.TFVARS_FILE }}
        else
          terraform apply -auto-approve
        fi

    - name: Terraform Destroy
      if: contains(github.event.head_commit.message, 'destroy') && !contains(github.event.head_commit.message, 'deploy')
      working-directory: ${{ github.workspace }}
      run: |
        if [ -n "${{ steps.extract_tfvars.outputs.TFVARS_FILE }}" ]; then
          terraform destroy -auto-approve -var-file=${{ steps.extract_tfvars.outputs.TFVARS_FILE }}
        else
          terraform destroy -auto-approve
        fi

    - name: Cleanup
      if: always()
      run: |
        echo "=== Limpieza final ==="
        rm -rf /tmp/terraform* 2>/dev/null || true
        df -h